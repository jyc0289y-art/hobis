<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HOBIS">
    
    <title>HOBIS - Radiation Protection System</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* HOBIS UI SYSTEM V4.15 (STABLE ENGINE) */
        :root {
            --hobis-green: #00ff33;
            --hobis-cyan: #00f7ff;
            --hobis-bg: #0a0a0c;
            --hobis-panel: #111418;
            --hobis-border: #2a3b47;
            --hobis-alert: #ff3300;
            --hobis-warn: #ffcc00;
            --input-bg: #0f1215;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--hobis-bg);
            color: var(--hobis-green);
            font-family: 'Share Tech Mono', monospace;
            margin: 0; 
            padding: calc(env(safe-area-inset-top) + 10px) env(safe-area-inset-right) 20px env(safe-area-inset-left);
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                              linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 2px, 3px 100%;
            font-size: 16px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- HEADER --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--hobis-border);
        }
        h1 {
            font-family: 'Orbitron', sans-serif; margin: 0; font-size: 1.4rem;
            color: var(--hobis-cyan); text-shadow: 0 0 10px var(--hobis-cyan);
        }
        .fs-btn {
            background: transparent; border: 1px solid var(--hobis-cyan); color: var(--hobis-cyan);
            padding: 6px 12px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 0.75rem;
        }

        .container { max-width: 1400px; margin: 0 auto; width: 100%; padding: 0 15px; display: flex; flex-direction: column; }
        
        /* --- LAYOUT --- */
        .workspace { display: flex; flex-direction: column; gap: 20px; flex: 1; }
        @media (min-width: 1024px) { 
            .workspace { flex-direction: row; align-items: stretch; } 
            .col-left { flex: 1.2; min-width: 0; display: flex; flex-direction: column; gap: 15px; } 
            .col-right { flex: 0.8; min-width: 0; display: flex; flex-direction: column; gap: 15px; } 
        }
        
        .panel { background: var(--hobis-panel); border: 1px solid var(--hobis-border); padding: 15px; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border-radius: 4px; }
        .panel::before { content:""; position:absolute; top:-1px; left:-1px; width:10px; height:10px; border-top:2px solid var(--hobis-cyan); border-left:2px solid var(--hobis-cyan); }
        .panel::after { content:""; position:absolute; bottom:-1px; right:-1px; width:10px; height:10px; border-bottom:2px solid var(--hobis-cyan); border-right:2px solid var(--hobis-cyan); }
        .header { color: var(--hobis-cyan); font-family: 'Orbitron', sans-serif; font-size: 1.0rem; margin-bottom: 10px; border-bottom: 1px dashed var(--hobis-border); display: flex; justify-content: space-between; align-items: center; padding-bottom: 5px; flex-wrap: wrap; gap: 5px; }
        
        .placeholder-box { display: flex; align-items: center; justify-content: center; height: 100%; min-height: 300px; color: #3c4c56; font-size: 0.9rem; border: 1px dashed #2a3b47; border-radius: 4px; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-shrink: 0; }
        .tab-btn { flex: 1; background: #15191d; border: 1px solid var(--hobis-border); color: #5f7481; padding: 12px; cursor: pointer; font-family: 'Orbitron', sans-serif; font-weight: bold; border-radius: 4px; text-align: center; transition: 0.2s; }
        .tab-btn.active { background: rgba(0, 247, 255, 0.15); color: var(--hobis-cyan); border-color: var(--hobis-cyan); box-shadow: 0 0 10px rgba(0, 247, 255, 0.1); }
        
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        @media (max-width: 600px) { .grid-row { grid-template-columns: 1fr; } }
        
        label { display: block; color: #8fa3b0; margin-bottom: 4px; font-size: 0.8rem; }
        input, select { background: var(--input-bg); border: 1px solid #3c4c56; color: var(--hobis-green); padding: 10px; width: 100%; border-radius: 3px; font-family: 'Share Tech Mono', monospace; font-size: 0.95rem; outline: none; }
        input:focus, select:focus { border-color: var(--hobis-cyan); }
        .input-group { display: flex; gap: 5px; } .input-group input { flex: 7; } .input-group select { flex: 3; text-align:center; }
        
        .btn { width: 100%; padding: 14px; background: rgba(0, 255, 51, 0.1); border: 1px solid var(--hobis-green); color: var(--hobis-green); font-family: 'Orbitron', sans-serif; font-weight: bold; font-size: 1rem; cursor: pointer; border-radius: 4px; margin-top: 10px; transition: 0.2s; }
        .btn:hover { background: rgba(0, 255, 51, 0.2); }
        .btn-outline { padding: 6px 12px; border: 1px solid #3c4c56; border-radius: 4px; background: rgba(0,0,0,0.3); color: #8fa3b0; cursor: pointer; font-size: 0.8rem; }
        
        .file-upload-box { border: 1px dashed var(--hobis-cyan); padding: 10px; text-align: center; border-radius: 4px; background: rgba(0, 247, 255, 0.05); margin-bottom: 10px; }
        .cust-list { max-height: 250px; overflow-y: auto; border-top: 1px solid #3c4c56; margin-top:10px; }
        .cust-item { padding: 10px; border-bottom: 1px solid #2a3b47; cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .cust-item:hover { background: rgba(255,255,255,0.05); }
        .cust-name { color: var(--hobis-cyan); font-weight: bold; }
        .cust-addr { color: #8fa3b0; font-size: 0.8rem; }
        .item-add-btn { background: transparent; border: 1px solid #5f7481; color: #5f7481; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 10px; }
        .inv-item { padding: 8px; border-bottom: 1px solid #2a3b47; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .inv-badge { background: #1a2329; color: var(--hobis-warn); padding: 2px 4px; border-radius: 3px; margin-right: 5px; }
        .inv-meta { color: #8fa3b0; font-size: 0.75rem; display: block; margin-top: 2px; }
        
        .info-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .info-table td { padding: 6px; border-bottom: 1px solid #2a3b47; vertical-align: top; }
        .info-table .key { color: #8fa3b0; width: 30%; }
        .info-table .val { color: white; word-break: break-all; }
        
        #mapWrapper { position: relative; margin-top: 10px; height: 300px; }
        #map { height: 100%; width: 100%; border-radius: 4px; border: 1px solid var(--hobis-border); z-index: 1; }
        .map-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; border-radius: 0 !important; margin: 0 !important; }
        #mapExpandBtn { position: absolute; top: 10px; right: 10px; z-index: 10000; background: rgba(0,0,0,0.8); border: 1px solid var(--hobis-cyan); color: var(--hobis-cyan); padding: 5px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; }
        .map-links { display: flex; gap: 5px; margin-top: 10px; }
        .map-btn { flex: 1; padding: 8px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.8rem; }
        .naver-btn { background: #2DB400; } .kakao-btn { background: #FEE500; color: black; } .google-btn { background: #4285F4; }
        .share-btn { background: var(--hobis-cyan); color: #000; margin-left: 5px;}

        .route-card { background: rgba(255, 255, 255, 0.02); border-left: 3px solid var(--hobis-warn); padding: 10px; margin-bottom: 10px; border-radius: 4px; position: relative; }
        .route-del-btn { position: absolute; top: 5px; right: 5px; color: var(--hobis-alert); cursor: pointer; }
        .route-path-box { background: #0f1215; border: 1px solid #3c4c56; padding: 8px; border-radius: 3px; font-size: 0.85rem; color: #a0c0c0; min-height: 35px; margin-top: 5px; }
        .route-node { display: inline-block; color: var(--hobis-cyan); padding-right: 5px; }
        .cargo-list { margin-top: 8px; padding-top: 8px; border-top: 1px dashed #3c4c56; font-size: 0.8rem; color: #8fa3b0; }

        .chart-container { height: 300px; position: relative; margin-top: 10px; }
        .log-container { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 5px; font-size: 0.8rem; color: #a0c0c0; }
        .log-item { padding: 5px; border-bottom: 1px solid #2a3b47; }
        
        .hidden { display: none !important; }
        .mode-switch { display: flex; background: rgba(0,0,0,0.4); border-radius: 6px; margin-bottom: 15px; padding: 4px; }
        .mode-opt { flex: 1; text-align: center; padding: 8px; cursor: pointer; color: #5f7481; font-weight: bold; transition: 0.2s; border-radius: 4px; }
        .mode-opt.active { background: rgba(0, 255, 51, 0.15); color: var(--hobis-green); }
        
        .result-box { margin-top: 10px; }
        .res-val { font-size: 1.5rem; color: var(--hobis-cyan); font-weight: bold; word-break: break-all; }
        .list-item { background: rgba(255, 255, 255, 0.02); border-left: 3px solid var(--hobis-border); padding: 10px; margin-bottom: 8px; position: relative; border-radius: 0 4px 4px 0; }
        .del-btn { position: absolute; right: 0; top: 0; color: var(--hobis-alert); cursor: pointer; font-size: 1.5rem; padding: 10px; line-height: 0.8; z-index: 5; }
        .spec-mini { font-size: 0.75rem; color: #5f7481; margin-top: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <h1>HOBIS v4.15</h1>
        <button class="fs-btn" onclick="toggleFullScreen()">‚õ∂ FULL SCREEN</button>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="setMainTab('decay')">DECAY</button>
        <button class="tab-btn" onclick="setMainTab('shield')">SHIELD</button>
        <button class="tab-btn" onclick="setMainTab('logistics')">LOGISTICS</button>
    </div>

    <div class="workspace">
        <!-- LEFT COLUMN -->
        <div class="col-left">
            <!-- CALC PANEL -->
            <div id="calcPanel" class="panel">
                <div class="header" id="panelTitle">DECAY OPS</div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                    DB LINK: 
                    <select id="dbSelector" style="width:auto; padding:2px;" onchange="loadDB()">
                        <option value="QSA">QSA</option>
                        <option value="ICRP107">ICRP 107</option>
                    </select>
                    <span id="sysStatus" style="color:var(--hobis-green); margin-left:10px;">INIT...</span>
                </div>
                <div id="decayModeSwitch" class="mode-switch">
                    <div class="mode-opt active" onclick="setSubMode('decay_forward', this)">FORWARD</div>
                    <div class="mode-opt" onclick="setSubMode('decay_reverse', this)">REVERSE</div>
                </div>
                <div id="shieldModeSwitch" class="mode-switch hidden">
                    <div class="mode-opt active" onclick="setSubMode('shield_forward', this)">FORWARD</div>
                    <div class="mode-opt" onclick="setSubMode('shield_reverse', this)">REVERSE</div>
                </div>
                <div id="inputArea"></div>
                <button class="btn" onclick="calculate()">EXECUTE</button>
            </div>

            <!-- LOGISTICS PANEL -->
            <div id="logisticsLeftPanel" class="panel hidden">
                <div class="header">LOGISTICS & INVENTORY</div>
                <div class="file-upload-box">
                    <label for="custFile" style="cursor:pointer; color:var(--hobis-cyan); font-weight:bold;">üìÇ LOAD CUSTOMERS</label>
                    <input type="file" id="custFile" accept=".csv" style="display:none;" onchange="handleCustFile(event)">
                    <select id="custEncoding" style="width:auto; padding:2px; font-size:0.8rem; margin-left:5px;"><option value="EUC-KR">EUC-KR</option><option value="UTF-8">UTF-8</option></select>
                    <div id="custFileStatus" style="font-size:0.8rem; color:#666;">Waiting...</div>
                </div>
                <div class="grid-row" style="margin-bottom:5px;">
                    <input type="text" id="custSearch" placeholder="Search Customer..." onkeyup="searchCustomer()">
                    <button class="btn-outline" style="width:auto;" onclick="renderCustomerList(customerDB)">LIST ALL</button>
                </div>
                <div id="customerResultList" class="cust-list" style="height:150px; margin-bottom:20px;"></div>

                <div class="header" style="color:var(--hobis-warn); border-color:var(--hobis-warn);">SOURCE INVENTORY</div>
                <div class="file-upload-box" style="border-color:var(--hobis-warn); background:rgba(255,204,0,0.05);">
                    <label for="sourceFile" style="cursor:pointer; color:var(--hobis-warn); font-weight:bold;">üìÇ LOAD SOURCES (MULTI)</label>
                    <input type="file" id="sourceFile" accept=".csv,.xlsx" multiple style="display:none;" onchange="handleSourceFiles(event)">
                    <select id="sourceEncoding" style="width:auto; padding:2px; font-size:0.8rem; margin-left:5px;"><option value="EUC-KR">EUC-KR</option><option value="UTF-8">UTF-8</option></select>
                    <div id="sourceFileStatus" style="font-size:0.8rem; color:#666;">Load 'DATA BASE' sheets</div>
                </div>
                <div id="inventoryList" class="cust-list" style="height:200px;">
                    <div style="padding:10px; text-align:center; color:#666;">No items loaded.</div>
                </div>
                <div class="header" style="margin-top:20px;">TRANSPORT ROUTES <button class="btn-outline" onclick="addRouteRow()">+</button></div>
                <div id="routeContainer"></div>
            </div>

            <!-- LOG -->
            <div class="panel">
                <div class="header">
                    <span>MISSION LOG</span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-outline" onclick="downloadCSV()">EXPORT</button>
                        <button class="btn-outline" style="color:var(--hobis-alert); border-color:var(--hobis-alert);" onclick="clearLog()">CLEAR</button>
                    </div>
                </div>
                <div id="logContainer" class="log-container"><div style="text-align:center; padding:10px; color:#555;">Ready.</div></div>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-right">
            <!-- INTEL PANEL -->
            <div id="rightDetailPanel" class="panel hidden" style="flex-grow:1;">
                <div class="header" style="color:white;">INTELLIGENCE DISPLAY</div>
                <div id="emptyState" class="placeholder-box">Select Customer to View Intel</div>
                <div id="intelContent" class="hidden">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:var(--hobis-cyan); font-weight:bold;">ENTITY DATA</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-outline" onclick="copyCustomerInfo()">COPY</button>
                            <button class="btn-outline" onclick="shareCustomerInfo()">SHARE</button>
                        </div>
                    </div>
                    <table class="info-table" id="infoTableBody"></table>
                    <div style="margin-top:20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:bold; color:#8fa3b0;">GEOSPATIAL</span>
                            <button class="btn-outline" style="font-size:0.7rem;" onclick="shareMapLocation()">SHARE MAP</button>
                        </div>
                        <div id="mapWrapper"><button id="mapExpandBtn" onclick="toggleMapSize()">‚õ∂ EXPAND</button><div id="map"></div></div>
                        <div class="map-links">
                            <button class="map-btn naver-btn" onclick="openMap('naver')">NAVER</button>
                            <button class="map-btn kakao-btn" onclick="openMap('kakao')">KAKAO</button>
                            <button class="map-btn google-btn" onclick="openMap('google')">Google</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORT PANEL -->
            <div id="rightReportPanel" class="panel" style="border-color:var(--hobis-green); flex-grow:1;">
                <div class="header">CALCULATION REPORT</div>
                <div id="reportEmpty" class="placeholder-box">Ready for Calculation</div>
                <div id="resultBox" class="hidden">
                    <div class="res-val" id="resMain">-</div>
                    <div style="font-size:0.9rem; color:#8fa3b0; margin-top:5px;" id="resSub"></div>
                    <div class="chart-container"><canvas id="opsChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="hobis_db.js"></script>

<script>
    // --- HOBIS KERNEL V4.15 ---
    let currentMainTab='decay', currentSubMode='decay_forward';
    let currentData=[], myChart=null, nucOptionsHTML="", logHistory=[];
    let customerDB=[], customerHeaders=[], sourceInventory=[], selectedCustomer=null;
    let map=null, marker=null;

    const UNIT_ACT = { "Ci":1, "TBq":27.027, "GBq":0.027027, "Bq":2.7027e-11 };
    const UNIT_DOSE = { "mSv/h":1, "uSv/h":0.001, "R/h":10, "mR/h":0.01 };

    function isIOS(){return ['iPad Simulator','iPhone Simulator','iPod Simulator','iPad','iPhone','iPod'].includes(navigator.platform)||(navigator.userAgent.includes("Mac")&&"ontouchend" in document);}
    function toggleFullScreen(){ if(isIOS()){alert("iOS: Use [Share] -> [Add to Home Screen]");return;} if(!document.fullscreenElement)document.documentElement.requestFullscreen().catch(e=>console.log(e)); else if(document.exitFullscreen)document.exitFullscreen(); }

    window.onload=function(){ if(typeof GLOBAL_DB==='undefined'){alert("DB Error");}else{loadDB();renderInputs();addRouteRow(); setTimeout(()=>{if(!map){map=L.map('map').setView([36.5,127.5],7);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);}},500);} };
    function loadDB(){ const t=document.getElementById('dbSelector').value; currentData=GLOBAL_DB[t]||[]; document.getElementById('sysStatus').innerText=`${t} ONLINE (${currentData.length})`; nucOptionsHTML=`<option value="MANUAL">[ MANUAL INPUT ]</option>`; currentData.forEach(n=>{nucOptionsHTML+=`<option value="${n.id}">${n.id}</option>`;}); }
    
    function addDays(dateStr, days) { const r=new Date(dateStr); r.setDate(r.getDate()+days); return r.toISOString().split('T')[0]; }

    // --- MODE SWITCH VISIBILITY FIX ---
    function setMainTab(t){
        currentMainTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active');
        
        if(t==='logistics'){ 
            document.getElementById('calcPanel').classList.add('hidden'); 
            document.getElementById('logisticsLeftPanel').classList.remove('hidden'); 
            document.getElementById('rightDetailPanel').classList.remove('hidden'); 
            document.getElementById('rightReportPanel').classList.add('hidden'); 
            if(map)setTimeout(()=>map.invalidateSize(),200); 
        }
        else{ 
            document.getElementById('calcPanel').classList.remove('hidden'); 
            document.getElementById('logisticsLeftPanel').classList.add('hidden'); 
            document.getElementById('rightDetailPanel').classList.add('hidden'); 
            document.getElementById('rightReportPanel').classList.remove('hidden'); 
            
            document.getElementById('panelTitle').innerText=t==='decay'?"DECAY OPS":"SHIELD OPS"; 
            
            // VISIBILITY FIX: Use classList remove to ensure display
            if(t === 'decay') {
                document.getElementById('decayModeSwitch').classList.remove('hidden');
                document.getElementById('shieldModeSwitch').classList.add('hidden');
                setSubMode('decay_forward', document.querySelector('#decayModeSwitch .mode-opt'));
            } else {
                document.getElementById('decayModeSwitch').classList.add('hidden');
                document.getElementById('shieldModeSwitch').classList.remove('hidden');
                setSubMode('shield_forward', document.querySelector('#shieldModeSwitch .mode-opt'));
            }
        }
    }
    
    function setSubMode(m,e){ 
        currentSubMode=m; 
        e.parentElement.querySelectorAll('.mode-opt').forEach(o=>o.classList.remove('active')); 
        e.classList.add('active'); 
        renderInputs(); 
        document.getElementById('reportEmpty').classList.remove('hidden'); 
        document.getElementById('resultBox').classList.add('hidden'); 
    }

    // --- LOGISTICS OPS (Preserved) ---
    function handleCustFile(e){ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=function(ev){ parseCustCSV(ev.target.result); document.getElementById('custFileStatus').innerText=`LOADED: ${f.name} (${customerDB.length})`; document.getElementById('custFileStatus').style.color="var(--hobis-green)"; }; r.readAsText(f, document.getElementById('custEncoding').value); }
    function parseCustCSV(txt){
        const lines=txt.split(/\r\n|\n/); customerHeaders=lines[0].split(',').map(h=>h.replace(/"/g,'').trim()); customerDB=[];
        const idxName=customerHeaders.findIndex(h=>h.includes('ÌöåÏÇ¨Î™Ö')||h.includes('Company')); const idxAddr=customerHeaders.findIndex(h=>h.includes('Ï£ºÏÜå')&&!h.includes('ÏÉÅÏÑ∏'));
        for(let i=1;i<lines.length;i++){ if(lines[i].trim()==="")continue; const cols=parseLine(lines[i]); if(cols.length<customerHeaders.length)continue; let obj={}; customerHeaders.forEach((h,idx)=>{obj[h]=cols[idx]||"";}); obj._searchStr=Object.values(obj).join(' ').toLowerCase(); obj._displayName=idxName>-1?cols[idxName]:cols[0]; obj._displayAddr=idxAddr>-1?cols[idxAddr]:""; customerDB.push(obj); }
    }
    function parseLine(l){ const r=[]; let q=false,t=""; for(let i=0;i<l.length;i++){ const c=l[i]; if(c==='"'){q=!q;continue;} if(c===','&&!q){r.push(t);t="";}else t+=c; } r.push(t); return r; }
    function searchCustomer(){ const q=document.getElementById('custSearch').value.toLowerCase().replace(/\s/g,''); const l=document.getElementById('customerResultList'); l.innerHTML=""; if(q.length<1)return; const r=customerDB.filter(c=>c._searchStr.replace(/\s/g,'').includes(q)); renderCustomerList(r); }
    function renderCustomerList(list){ const el=document.getElementById('customerResultList'); el.innerHTML=""; list.forEach(c=>{ const d=document.createElement('div'); d.className='cust-item'; d.innerHTML=`<div class="cust-main" onclick="selectCust(this)"><div class="cust-name">${c._displayName}</div><div class="cust-addr">${c._displayAddr}</div></div><button class="item-add-btn" onclick="addToActiveRoute('${c._displayName}')">[+]</button>`; d.querySelector('.cust-main').data=c; el.appendChild(d); }); if(list.length===0)el.innerHTML=`<div style="padding:10px; color:#666; text-align:center;">No match</div>`; }
    function selectCust(el){ selectedCustomer=el.data; document.getElementById('emptyState').classList.add('hidden'); document.getElementById('intelContent').classList.remove('hidden'); const b=document.getElementById('infoTableBody'); b.innerHTML=""; customerHeaders.forEach(h=>{if(selectedCustomer[h])b.innerHTML+=`<tr><td class="key">${h}</td><td class="val">${selectedCustomer[h]}</td></tr>`;}); if(selectedCustomer._displayAddr)searchOSM(selectedCustomer._displayAddr); }
    function handleSourceFiles(e){ const files=e.target.files; if(!files.length)return; sourceInventory=[]; let loaded=0; const encoding=document.getElementById('sourceEncoding').value; Array.from(files).forEach(f=>{ const r=new FileReader(); r.onload=function(ev){ parseSourceCSV(ev.target.result, f.name); loaded++; if(loaded===files.length) renderInventory(); }; r.readAsText(f, encoding); }); }
    function parseSourceCSV(txt, fname){
        const lines=txt.split(/\r\n|\n/); let meta={qty:0,nuc:"Unknown",dateExport:""};
        lines.forEach(l=>{ if(!l.trim())return; const r=l.split(','); r.forEach((c,i)=>{ const v=c.replace(/"/g,'').trim(); const nv=r[i+1]?r[i+1].replace(/"/g,'').trim():""; if(v.includes("ÏàòÎüâ")&&!meta.qty&&!isNaN(parseInt(nv)))meta.qty=parseInt(nv); if(v.includes("ÌïµÏ¢Ö"))meta.nuc=nv; if(v.includes("Î∞òÏ∂úÏùºÏûê"))meta.dateExport=nv; }); if(meta.nuc==="Unknown"){if(l.includes("Ir-192"))meta.nuc="Ir-192";else if(l.includes("Se-75"))meta.nuc="Se-75";else if(l.includes("Co-60"))meta.nuc="Co-60";} });
        let hIdx=-1; for(let i=0;i<Math.min(30,lines.length);i++){if(lines[i].includes('No.')&&(lines[i].includes('Î∞©ÏÇ¨Îä•')||lines[i].includes('Ci')||lines[i].includes('ÏÑ†ÏõêÏùºÎ†®Î≤àÌò∏'))){hIdx=i;break;}}
        if(hIdx!==-1&&meta.qty>0){ const h=lines[hIdx].split(',').map(s=>s.trim().replace(/"/g,'')); const iNo=h.findIndex(x=>x.includes('No')); const iSN=h.findIndex(x=>x.includes('ÏÑ†ÏõêÏùºÎ†®Î≤àÌò∏')||x.includes('S/N')); const iCi=h.findIndex(x=>x.includes('Ci')); const iMng=h.findIndex(x=>x.includes('Í¥ÄÎ¶¨Î≤àÌò∏'));
            for(let i=1;i<=meta.qty;i++){ const ri=hIdx+i; if(ri>=lines.length)break; const cols=parseLine(lines[ri]); if(!cols[iNo]||isNaN(parseInt(cols[iNo])))continue; let sn=cols[iSN]||""; if(iSN>-1&&cols[iSN+1]&&cols[iSN+1].length<10)sn+="-"+cols[iSN+1]; sourceInventory.push({no:cols[iNo],sn:sn,mng:iMng>-1?cols[iMng]:"",actCi:iCi>-1?cols[iCi]:"0",nuc:meta.nuc,date:meta.dateExport,file:fname}); } }
    }
    function renderInventory(){ document.getElementById('invCount').innerText=`${sourceInventory.length} Items`; const l=document.getElementById('inventoryList'); l.innerHTML=""; sourceInventory.forEach(i=>{ const d=document.createElement('div'); d.className='inv-item'; d.innerHTML=`<div><span class="inv-badge">${i.nuc}</span><b>${i.actCi} Ci</b><span class="inv-meta">S/N: ${i.sn}</span><span class="inv-meta" style="font-size:0.7rem;color:#555;">${i.date} (${i.file})</span></div><button class="item-add-btn" onclick="addToActiveRouteCargo('${i.nuc} ${i.actCi}Ci (${i.sn})')">ADD</button>`; l.appendChild(d); }); }
    function addRouteRow(){ const c=document.getElementById('routeContainer'); const d=document.createElement('div'); d.className='route-card'; d.innerHTML=`<div class="route-del-btn" onclick="this.parentElement.remove()">√ó</div><div class="route-meta"><input type="date" class="route-date"><input type="text" placeholder="Vehicle"><input type="text" placeholder="Manager"><input type="text" placeholder="Passenger"></div><div><label>Route (Format: A - B - C)</label><input type="text" class="route-input" onkeyup="parseRoute(this)" placeholder="Ex: Seoul - Busan"></div><div class="route-path-box"></div><div class="cargo-list">üì¶ Cargo: <span class="cargo-content">None</span></div>`; c.appendChild(d); d.querySelector('.route-date').value=new Date().toISOString().split('T')[0]; }
    function parseRoute(el){ const box=el.parentElement.parentElement.querySelector('.route-path-box'); box.innerHTML=""; const parts=el.value.split('-').map(s=>s.trim()).filter(s=>s.length>0); parts.forEach((p,i)=>{ const q=p.toLowerCase().replace(/\s/g,''); const m=customerDB.find(c=>c._displayName.toLowerCase().replace(/\s/g,'').includes(q)); const s=document.createElement('span'); s.className='route-node'; if(m){s.innerText=m._displayName; s.style.border="1px solid var(--hobis-cyan)";}else{s.innerText=p+" (?)"; s.style.color="#8fa3b0"; s.style.border="1px dashed #5f7481";} box.appendChild(s); if(i<parts.length-1){const a=document.createElement('span'); a.className='route-arrow'; a.innerHTML='‚ûú'; box.appendChild(a);} }); }
    function addToActiveRoute(n){ const all=document.querySelectorAll('.route-input'); if(!all.length){addRouteRow();return addToActiveRoute(n);} const l=all[all.length-1]; let v=l.value.trim(); if(v.length>0&&!v.endsWith('-'))v+=" - "; l.value=v+n; parseRoute(l); }
    function addToActiveRouteCargo(i){ const all=document.querySelectorAll('.cargo-content'); if(!all.length){alert("Create route first.");return;} const l=all[all.length-1]; if(l.innerText==="None")l.innerText=i; else l.innerText+=", "+i; }
    function copyCustomerInfo(){if(!selectedCustomer)return; let t=`[HOBIS]\n`; customerHeaders.forEach(h=>{if(selectedCustomer[h])t+=`${h}: ${selectedCustomer[h]}\n`;}); navigator.clipboard.writeText(t).then(()=>alert("Copied!"));}
    function shareCustomerInfo(){if(!selectedCustomer)return; let t=`[HOBIS]\n`; customerHeaders.forEach(h=>{if(selectedCustomer[h])t+=`${h}: ${selectedCustomer[h]}\n`;}); if(navigator.share)navigator.share({title:selectedCustomer._displayName,text:t}); else navigator.clipboard.writeText(t).then(()=>alert("Copied!"));}
    function shareMapLocation(){if(!selectedCustomer)return; const u=`https://map.naver.com/v5/search/${encodeURIComponent(selectedCustomer._displayAddr)}`; if(navigator.share)navigator.share({title:"Location",url:u}); else navigator.clipboard.writeText(u).then(()=>alert("Link Copied!"));}
    function searchOSM(addr){ doFetch(addr,()=>{const c=addr.replace(/\(.*\)/g,'').trim();if(c!==addr)doFetch(c,null);}); }
    function doFetch(q,fail){ fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`).then(r=>r.json()).then(d=>{if(d.length){const p=d[0]; map.setView([p.lat,p.lon],16); if(marker)map.removeLayer(marker); marker=L.marker([p.lat,p.lon]).addTo(map);}else if(fail)fail();}).catch(()=>{if(fail)fail();}); }
    function toggleMapSize(){ const m=document.getElementById('map'); const b=document.getElementById('mapExpandBtn'); const f=m.classList.toggle('map-fullscreen'); b.innerHTML=f?"‚Ü© SHRINK":"‚õ∂ EXPAND"; setTimeout(()=>map.invalidateSize(),100); }
    function openMap(t){ if(!selectedCustomer)return; const q=encodeURIComponent(selectedCustomer._displayAddr); window.open(t==='naver'?`https://map.naver.com/v5/search/${q}`:t==='kakao'?`https://map.kakao.com/link/search/${q}`:`http://google.com/maps?q=${q}`,'_blank'); }

    // --- CALC UI (FIXED: SHIELD FORWARD INPUT MODE) ---
    function renderInputs() {
        const area = document.getElementById('inputArea'); area.innerHTML = "";
        
        // 1. DECAY FORWARD
        if(currentSubMode === 'decay_forward') {
            area.innerHTML = `
                <div style="margin-bottom:15px; border-bottom:1px dashed #3c4c56; padding-bottom:10px;">
                    <div class="header" style="border:none; margin:0;"><span>SOURCES</span> <button class="btn-outline" onclick="addSourceRow()">+ ADD</button></div>
                    <div id="sourceList"></div>
                </div>
                <div class="grid-row"><div><label>Start</label><input type="date" id="dateStart"></div><div><label>Eval</label><input type="date" id="dateEnd"></div></div>
                <div class="grid-row"><div><label>Result Unit</label><select id="outUnit">${getUnitOpts('act')}</select></div></div>`;
            addSourceRow(); 
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateStart').value = today; document.getElementById('dateEnd').value = today;
        } 
        // 2. DECAY REVERSE
        else if(currentSubMode === 'decay_reverse') {
            area.innerHTML = `
                <div class="grid-row"><div><label>Nuclide</label><select id="nucSelect" onchange="updateRowSpec(this)">${nucOptionsHTML}</select><div class="spec-mini" id="specDisplay">-</div></div><div><label>Initial (A0)</label><div class="input-group"><input type="number" id="inA0"><select id="unitA0">${getUnitOpts('act')}</select></div></div></div>
                <div class="grid-row"><div><label>Target (At)</label><input type="number" id="inTargetAct"></div><div><label>Start</label><input type="date" id="dateStart"></div></div>`;
            document.getElementById('dateStart').value = new Date().toISOString().split('T')[0]; updateRowSpec(document.getElementById('nucSelect'));
        } 
        // 3. SHIELD FORWARD (PATCH 5: INPUT MODE SELECTOR)
        else if(currentSubMode === 'shield_forward') {
            area.innerHTML = `
                <div style="margin-bottom:15px;">
                     <div class="grid-row" style="margin-bottom:0;">
                        <div>
                            <label>Input Mode</label>
                            <select id="inputType" onchange="updateShieldFwdInputUnit()">
                                <option value="act">Based on Activity</option>
                                <option value="dose">Based on Measured Dose</option>
                            </select>
                        </div>
                        <div class="header" style="border:none; margin:0; justify-content:flex-end;"><span>SOURCES</span> <button class="btn-outline" onclick="addSourceRow()">+ ADD</button></div>
                    </div>
                    <div id="sourceList"></div>
                </div>
                
                <div class="grid-row"><div><label>Distance(m)</label><input type="number" id="inDist" value="1"></div></div>
                
                <div style="margin:15px 0;"><div class="header" style="border:none;"><span>LAYERS</span> <button class="btn-outline" onclick="addLayerRow()">+ ADD</button></div><div id="layerList"></div></div>
                
                <div class="grid-row"><div><label>Out Type</label><select id="outType" onchange="updateOutUnit()"><option value="dose">Dose Rate</option><option value="act">Eff. Activity</option></select></div><div><label>Out Unit</label><select id="outUnit">${getUnitOpts('dose')}</select></div></div>`;
            addSourceRow(); addLayerRow();
        } 
        // 4. SHIELD REVERSE
        else { 
            area.innerHTML = `
                <div class="grid-row">
                    <div><label>Nuclide</label><select id="nucSelect" onchange="updateRowSpec(this)">${nucOptionsHTML}</select><div class="spec-mini" id="specDisplay">-</div></div>
                    <div>
                        <label>Input Mode</label>
                        <select id="inputType" onchange="updateReverseInUnit()">
                            <option value="act">Activity</option>
                            <option value="dose">Dose Rate</option>
                        </select>
                    </div>
                </div>
                <div class="grid-row">
                    <div><label>Input Value</label><div class="input-group"><input type="number" id="inVal"><select id="inUnit">${getUnitOpts('act')}</select></div></div>
                    <div><label>Dist (m)</label><input type="number" id="inDist" value="1"></div>
                </div>
                <div class="grid-row">
                    <div><label>Target Mode</label><select id="targetType" onchange="updateReverseTargetUnit()"><option value="dose">Dose Rate</option><option value="act">Activity</option></select></div>
                    <div><label>Target Val</label><div class="input-group"><input type="number" id="targetVal"><select id="targetUnit">${getUnitOpts('dose')}</select></div></div>
                </div>
                <div class="grid-row">
                    <div><label>Material</label><select id="targetMat"><option value="Lead">Lead</option><option value="Concrete">Concrete</option><option value="Steel">Steel</option><option value="Tungsten">W</option><option value="DU">DU</option></select></div>
                </div>`;
            updateRowSpec(document.getElementById('nucSelect'));
        }
    }

    // --- ROW & UNIT HELPERS ---
    function addSourceRow() {
        // For Shield Forward, unit depends on inputType
        let unitOpts = getUnitOpts('act');
        if (currentSubMode === 'shield_forward') {
            const inType = document.getElementById('inputType') ? document.getElementById('inputType').value : 'act';
            unitOpts = getUnitOpts(inType);
        }

        const div = document.createElement('div'); div.className = 'list-item source-row';
        div.innerHTML = `<div class="del-btn" onclick="this.parentElement.remove()">√ó</div><div class="grid-row" style="margin:0; gap:5px;"><div style="flex:1"><select class="src-select" onchange="updateRowSpec(this)">${nucOptionsHTML}</select></div><div style="flex:1"><div class="input-group"><input type="number" class="src-val"><select class="src-unit">${unitOpts}</select></div></div></div><div class="spec-mini">-</div>`;
        document.getElementById('sourceList').appendChild(div); updateRowSpec(div.querySelector('.src-select'));
    }
    
    function addLayerRow() {
        const div = document.createElement('div'); div.className = 'list-item shield-layer';
        div.innerHTML = `<div class="del-btn" onclick="this.parentElement.remove()">√ó</div><div class="grid-row" style="margin:0; gap:5px;"><div style="flex:1"><select class="mat-select"><option value="Lead">Lead</option><option value="Concrete">Concrete</option><option value="Steel">Steel</option><option value="Tungsten">W</option><option value="DU">DU</option></select></div><div style="flex:1"><input type="number" class="thk-input" placeholder="mm"></div></div>`;
        document.getElementById('layerList').appendChild(div);
    }
    
    function getUnitOpts(type) { 
        return type==='act' ? '<option value="Ci">Ci</option><option value="TBq">TBq</option><option value="GBq">GBq</option><option value="Bq">Bq</option>' 
        : '<option value="mSv/h">mSv/h</option><option value="uSv/h">uSv/h</option><option value="R/h">R/h</option><option value="mR/h">mR/h</option>'; 
    }
    
    function updateOutUnit() { document.getElementById('outUnit').innerHTML = getUnitOpts(document.getElementById('outType').value); }
    function updateReverseInUnit() { document.getElementById('inUnit').innerHTML = getUnitOpts(document.getElementById('inputType').value); }
    function updateReverseTargetUnit() { document.getElementById('targetUnit').innerHTML = getUnitOpts(document.getElementById('targetType').value); }
    
    // PATCH 5: Function to update units in dynamic rows when Shield Forward input type changes
    function updateShieldFwdInputUnit() {
        const inType = document.getElementById('inputType').value;
        const newOpts = getUnitOpts(inType);
        document.querySelectorAll('.src-unit').forEach(sel => {
            const oldVal = sel.value; // Try to keep value if possible (unlikely but good practice)
            sel.innerHTML = newOpts;
        });
    }

    function getNucData(id) { if(id==="MANUAL") return {id:"MANUAL"}; return currentData.find(n=>n.id===id); }
    function updateRowSpec(el) { const id=el.value; const nuc=getNucData(id); let disp=(el.id==="nucSelect")?document.getElementById('specDisplay'):el.parentElement.querySelector('.spec-mini'); if(nuc && disp) disp.innerText = id==="MANUAL"?"Manual":"HL:"+nuc.hl+nuc.unit; }
    function getHLDays(nuc) { let d=nuc.hl; if(nuc.unit==='h')d/=24; if(nuc.unit==='m')d/=1440; if(nuc.unit==='y')d*=365.25; return d; }

    function calculate() {
        document.getElementById('reportEmpty').classList.add('hidden');
        document.getElementById('resultBox').classList.remove('hidden');
        
        let entry = { mode:"", timestamp: new Date().toLocaleString(), totalInputVal:"", inputUnit:"", resultVal:"", resultUnit:"" }; 
        function getReadyNuc(id) { if(id!=="MANUAL") return getNucData(id); const h=prompt("HL(d)"); const g=prompt("Gamma"); const l=prompt("Pb HVL"); if(!h)return null; return {id:"MANUAL", hl:parseFloat(h), unit:'d', gamma:parseFloat(g), hvl:{'Lead':parseFloat(l)}}; }

        if(currentSubMode === 'decay_forward') {
            entry.mode="DECAY_FWD"; const outUnit=document.getElementById('outUnit').value;
            const sDate = document.getElementById('dateStart').value;
            const days = (new Date(document.getElementById('dateEnd').value) - new Date(sDate))/86400000;
            let total=0; let srcs=[];
            document.querySelectorAll('.source-row').forEach(r => {
                const n=getReadyNuc(r.querySelector('.src-select').value); const v=parseFloat(r.querySelector('.src-val').value)||0;
                if(n&&v>0) { const A0=v*UNIT_ACT[r.querySelector('.src-unit').value]; total+=A0*Math.pow(0.5, days/getHLDays(n)); srcs.push({n:n, A0:A0}); }
            });
            const res = total * (1/UNIT_ACT[outUnit]);
            entry.resultVal=res.toExponential(4); entry.resultUnit=outUnit;
            showResult(`${entry.resultVal} ${outUnit}`, `Elapsed: ${days.toFixed(1)}d`);
            addToLog(entry);
            const L=[], D=[]; let range=days>0?days*1.2:365;
            for(let i=0;i<=100;i++){ 
                let t=i*(range/100); let sum=0; srcs.forEach(s=>sum+=s.A0*Math.pow(0.5,t/getHLDays(s.n))); 
                L.push(t.toFixed(1)); D.push(sum*(1/UNIT_ACT[outUnit])); 
            }
            drawChart(L,D,"Activity","Days",days,res, sDate);
        }
        else if(currentSubMode === 'decay_reverse') {
            entry.mode="DECAY_REV";
            const sDate = document.getElementById('dateStart').value;
            const n=getReadyNuc(document.getElementById('nucSelect').value);
            const A0=parseFloat(document.getElementById('inA0').value); const At=parseFloat(document.getElementById('inTargetAct').value);
            if(n&&A0&&At){
                const days = getHLDays(n) * (Math.log(At/A0)/Math.log(0.5));
                const dDate = new Date(new Date(sDate).getTime() + days*86400000);
                const dDateStr = dDate.toISOString().split('T')[0];
                entry.resultVal=dDateStr; entry.resultUnit="(Date)"; 
                showResult(`${days.toFixed(1)} Days`, `Reach: ${dDateStr}`);
                addToLog(entry);
                const L=[], D=[]; for(let i=0;i<=100;i++){ let t=i*(days*1.2/100); L.push(t.toFixed(1)); D.push(A0*Math.pow(0.5,t/getHLDays(n))); }
                drawChart(L,D,"Decay","Days",days,At, sDate);
            }
        }
        else if(currentSubMode === 'shield_forward') {
            entry.mode="SHIELD_FWD"; const dist=parseFloat(document.getElementById('inDist').value)||1;
            const inType = document.getElementById('inputType').value; // PATCH 5
            const ot=document.getElementById('outType').value; const ou=document.getElementById('outUnit').value;
            let srcs=[], lays=[]; 
            
            document.querySelectorAll('.source-row').forEach(r=>{ 
                const n=getReadyNuc(r.querySelector('.src-select').value); 
                const v=parseFloat(r.querySelector('.src-val').value)||0; 
                if(n&&v>0) {
                    // Normalize input to common base (Ci or mSv/h)
                    // If inType is 'act', convert to Ci
                    // If inType is 'dose', convert to mSv/h
                    let val = 0;
                    if(inType === 'act') val = v * UNIT_ACT[r.querySelector('.src-unit').value];
                    else val = v * UNIT_DOSE[r.querySelector('.src-unit').value];
                    
                    srcs.push({n:n, val:val}); 
                }
            });
            document.querySelectorAll('.shield-layer').forEach(r=>{ lays.push({m:r.querySelector('.mat-select').value, t:parseFloat(r.querySelector('.thk-input').value)||0}); });
            
            let totalRes=0; 
            
            srcs.forEach(s=>{ 
                let trans=1.0; 
                lays.forEach(l=>{ let h=(s.n.hvl&&s.n.hvl[l.m])?s.n.hvl[l.m]:(l.m==='Lead'?s.n.hvl['Lead']:0); if(h>0)trans*=Math.pow(0.5,l.t/h); }); 
                
                // Logic based on Input Mode
                if (inType === 'act') {
                    // Input: Ci -> Calc Dose or Act
                    if(ot==='dose') totalRes += s.n.gamma * s.val * (1/(dist*dist)) * trans;
                    else totalRes += s.val * trans;
                } else {
                    // Input: mSv/h (@1m assumed) -> Calc Dose or Act
                    // Dose @ dist = Dose@1m * (1/d^2) * Trans
                    let d = s.val * (1/(dist*dist)) * trans;
                    if(ot==='dose') totalRes += d;
                    else totalRes += d / s.n.gamma; // Convert back to Act
                }
            });
            
            // Final Unit Conversion
            const finalVal = totalRes * (ot==='dose'?(1/UNIT_DOSE[ou]):(1/UNIT_ACT[ou]));
            
            entry.resultVal=finalVal.toExponential(4); entry.resultUnit=ou;
            showResult(`${entry.resultVal} ${ou}`, ot); addToLog(entry);
            
            // Chart (Primary Layer Curve)
            if(lays.length){ 
                const L=[], D=[], pm=lays[0].m, pt=lays[0].t; 
                let maxThk = pt*2 || 50; 
                for(let i=0;i<=100;i++){ 
                    let x=i*(maxThk/100), sum=0; 
                    srcs.forEach(s=>{ 
                        let tr=1.0, h1=(s.n.hvl&&s.n.hvl[pm])?src.n.hvl[pm]:0; if(h1>0)tr*=Math.pow(0.5,x/h1); 
                        for(let k=1;k<lays.length;k++) { let l=lays[k], h=(s.n.hvl&&s.n.hvl[l.m])?src.n.hvl[l.m]:0; if(h>0)tr*=Math.pow(0.5,l.t/h); } 
                        
                        if (inType === 'act') {
                             if(ot==='dose') sum += s.n.gamma * s.val * (1/(dist*dist)) * tr;
                             else sum += s.val * tr;
                        } else {
                             let d = s.val * (1/(dist*dist)) * tr;
                             if(ot==='dose') sum += d; else sum += d / s.n.gamma;
                        }
                    }); 
                    D.push(sum*(ot==='dose'?(1/UNIT_DOSE[ou]):(1/UNIT_ACT[outUnit]))); 
                } 
                drawChart(L,D,"Shield","mm",pt,finalVal); 
            }
        }
        else { // Shield Reverse
            entry.mode="SHIELD_REV"; 
            const n=getReadyNuc(document.getElementById('nucSelect').value); 
            const iv=parseFloat(document.getElementById('inVal').value); const target=parseFloat(document.getElementById('targetVal').value); 
            const dist=parseFloat(document.getElementById('inDist').value)||1; const mat=document.getElementById('targetMat').value;
            const inType = document.getElementById('inputType').value; // PATCH 5
            
            if(n&&iv&&target){ 
                let s=0,t=0; 
                if(inType === 'act') {
                    s = n.gamma * (iv*UNIT_ACT[document.getElementById('inUnit').value]) * (1/(dist*dist));
                } else {
                    s = (iv*UNIT_DOSE[document.getElementById('inUnit').value]) * (1/(dist*dist));
                }

                if(document.getElementById('targetType').value==='dose'){ 
                    t=target*UNIT_DOSE[document.getElementById('targetUnit').value]; 
                } else { 
                    t = n.gamma * (target*UNIT_ACT[document.getElementById('targetUnit').value]) * (1/(dist*dist));
                } 
                
                const req=t/s;
                if(req>=1) showResult("0 mm","None"); 
                else { 
                    let h=(n.hvl&&n.hvl[mat])?n.hvl[mat]:(mat==='Lead'?n.hvl['Lead']:0); 
                    if(h>0){ 
                        const thk=h*(Math.log(req)/Math.log(0.5)); 
                        entry.resultVal=thk.toFixed(2); entry.resultUnit="mm"; 
                        showResult(`${thk.toFixed(2)} mm`,mat); addToLog(entry); 
                        const L=[], D=[]; for(let i=0;i<=100;i++){ let x=i*(thk*1.5/100); L.push(x.toFixed(1)); D.push(s*Math.pow(0.5,x/h)); } 
                        drawChart(L,D,"Atten","mm",thk,t); 
                    } 
                } 
            }
        }
    }

    function addToLog(d) {
        logHistory.push(d);
        const div=document.createElement('div'); div.className='log-item';
        div.innerHTML=`<span class="log-time">[${d.timestamp}]</span> <span class="log-mode">${d.mode}</span> <span class="log-result">${d.resultVal} ${d.resultUnit}</span>`;
        document.getElementById('logContainer').prepend(div);
    }
    function clearLog() { logHistory=[]; document.getElementById('logContainer').innerHTML="Ready."; }
    function downloadCSV() {
        if(logHistory.length===0) return alert("Empty");
        let csv="\uFEFFTime,Mode,Res,Unit\n";
        logHistory.forEach(r=>csv+=`${r.timestamp},${r.mode},${r.resultVal},${r.resultUnit}\n`);
        const l=document.createElement('a'); l.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); l.download="LOG.csv"; l.click();
    }
    function showResult(m,s) { document.getElementById('resMain').innerText=m; document.getElementById('resSub').innerText=s; }
    
    // GRAPH WITH DATE INTELLIGENCE
    function drawChart(L,D,lbl,xl,mx,my, startDate) {
        if(myChart) myChart.destroy();
        const ctx=document.getElementById('opsChart').getContext('2d');
        let idx=0, min=9e9; 
        L.forEach((v,i)=>{ let d=Math.abs(v-mx); if(d<min){min=d;idx=i;} });
        const P=Array(L.length).fill(null); P[idx]=my;
        
        Chart.defaults.color='#5f7481';
        myChart=new Chart(ctx,{
            type:'line',
            data:{
                labels:L,
                datasets:[{
                    label:lbl, data:D, borderColor:'#00ff33', backgroundColor:'rgba(0,255,51,0.1)', 
                    fill:true, pointRadius:0, pointHoverRadius:6, borderWidth:2, tension:0.4
                },{
                    label:'Result', data:P, borderColor:'#ff9900', backgroundColor:'#ff9900', 
                    pointRadius:6, type:'scatter'
                }]
            },
            options:{
                responsive:true, maintainAspectRatio:false,
                interaction:{ mode:'index', intersect:false },
                plugins:{ 
                    tooltip:{ 
                        enabled:true, mode:'index', intersect:false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += context.parsed.y.toExponential(2);
                                
                                // Add Date Info if Start Date is provided (for Decay charts)
                                if (startDate && xl === "Days") {
                                    const dateStr = addDays(startDate, context.parsed.x);
                                    label += ` (${dateStr})`;
                                }
                                return label;
                            }
                        }
                    } 
                },
                scales:{ x:{title:{display:true, text:xl}, grid:{color:'#1f2b33'}}, y:{grid:{color:'#1f2b33'}} }
            }
        });
    }
</script>
</body>
</html>